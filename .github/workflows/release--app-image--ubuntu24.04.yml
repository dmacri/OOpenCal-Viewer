name: Build Qt-VTK Viewer AppImage

on:
  push:
    branches:
      - '**'
  release:
    types: [created]

env:
  PROJECT_NAME: OOpenCal-Viewer

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:
      ################### checkout & dependencies ###################
      - name: Checkout main repository
        uses: actions/checkout@v3

      - name: Checkout OOpenCAL dependency
        uses: actions/checkout@v3
        with:
          repository: alessioderango/OOpenCAL
          path: deps/OOpenCAL
          token: ${{ secrets.VisualizerOpenCal }}

      ################### environment & build tools ###################
      - name: Install build prerequisites
        run: |
          sudo apt update
          sudo apt install -y --no-install-recommends \
            build-essential \
            cmake \
            ninja-build \
            qtbase5-dev \
            qttools5-dev \
            qttools5-dev-tools \
            libvtk9-dev \
            libvtk9-qt-dev \
            libfreetype-dev \
            libeigen3-dev \
            libtiff-dev \
            libpng-dev \
            libjpeg-dev \
            zlib1g-dev \
            libgl1-mesa-dev \
            libglu1-mesa-dev \
            patchelf \
            file \
            wget

      - name: Download and extract clang mini toolchain
        run: |
          # Store headers and binaries in temporary locations (will copy to AppDir later)
          mkdir -p /tmp/clang-headers
          mkdir -p /tmp/clang-binaries
          mkdir -p /tmp/appimage-headers
          
          # Download clang mini toolchain (adjust version as needed)
          # Using LLVM releases from GitHub
          LLVM_VERSION="21.1.6"
          LLVM_RELEASE_URL="https://github.com/llvm/llvm-project/releases/download/llvmorg-${LLVM_VERSION}"
          CLANG_ARCHIVE="LLVM-${LLVM_VERSION}-Linux-X64.tar.xz"
          
          echo "Downloading clang toolchain version ${LLVM_VERSION}..."
          echo "URL: ${LLVM_RELEASE_URL}/${CLANG_ARCHIVE}"
          wget -q "${LLVM_RELEASE_URL}/${CLANG_ARCHIVE}" -O /tmp/clang.tar.xz || {
            echo "Failed to download LLVM ${LLVM_VERSION} from primary source"
            echo "Trying alternative URL..."
            # Try alternative format
            CLANG_ARCHIVE_ALT="clang+llvm-${LLVM_VERSION}-x86_64-linux-gnu-ubuntu-22.04.tar.xz"
            wget -q "${LLVM_RELEASE_URL}/${CLANG_ARCHIVE_ALT}" -O /tmp/clang.tar.xz || {
              echo "Failed to download from alternative source, using system clang"
              # Fallback: use system clang if available
              which clang++ && cp $(which clang++) AppDir/usr/bin/clang++ || true
              which clang && cp $(which clang) AppDir/usr/bin/clang || true
              exit 0
            }
          }
          
          echo "Extracting clang toolchain..."
          tar -xf /tmp/clang.tar.xz -C /tmp/ || {
            echo "Failed to extract clang toolchain"
            exit 1
          }
          
          # Find extracted directory
          # LLVM 21 uses different naming: LLVM-21.1.6-Linux-X64
          CLANG_DIR=$(find /tmp -maxdepth 1 -type d \( -name "clang+llvm*" -o -name "LLVM*" \) | head -1)
          echo "Looking for clang directory..."
          echo "Found directories in /tmp:"
          ls -d /tmp/clang* /tmp/LLVM* 2>/dev/null || echo "No clang/LLVM directories found"
          echo "CLANG_DIR set to: $CLANG_DIR"
          
          if [ -d "$CLANG_DIR" ]; then
            echo "Found clang at: $CLANG_DIR"
            
            # Copy clang binaries to temporary location (will copy to AppDir later)
            mkdir -p /tmp/clang-binaries/bin
            cp "$CLANG_DIR/bin/clang++" /tmp/clang-binaries/bin/ || true
            cp "$CLANG_DIR/bin/clang" /tmp/clang-binaries/bin/ || true
            cp "$CLANG_DIR/bin/clang-cpp" /tmp/clang-binaries/bin/ || true
            echo "✓ Clang binaries copied to temporary location"
            
            # Copy all clang libraries to temporary location (will copy to AppDir later)
            mkdir -p /tmp/clang-binaries/lib
            if [ -d "$CLANG_DIR/lib" ]; then
              echo "Clang lib directory contents:"
              ls -la "$CLANG_DIR/lib/" | head -30

              # Copy all .so files recursively
              echo ""
              echo "Copying .so files to temporary location..."
              find "$CLANG_DIR/lib" -name "*.so*" -type f | while read sofile; do
                echo "  Copying: $sofile"
                cp "$sofile" /tmp/clang-binaries/lib/ || echo "Failed to copy $sofile"
              done
              
              # Also try copying the entire lib directory
              echo "Copying entire lib directory..."
              if [ -d "$CLANG_DIR/lib/x86_64-unknown-linux-gnu" ]; then
                cp -rv "$CLANG_DIR/lib/x86_64-unknown-linux-gnu"/* /tmp/clang-binaries/lib/ 2>&1 | head -20
              fi
              
              # Copy any .so files in main lib directory
              if [ -f "$CLANG_DIR/lib/libclang.so"* ]; then
                cp -v "$CLANG_DIR/lib"/libclang*.so* /tmp/clang-binaries/lib/ 2>&1 || true
              fi
              
              echo ""
              echo "=== Clang libraries in temporary location ==="
              ls -lh /tmp/clang-binaries/lib/ 2>/dev/null | head -30 || echo "No files found!"
            else
              echo "ERROR: $CLANG_DIR/lib directory not found!"
              echo "Contents of $CLANG_DIR:"
              ls -la "$CLANG_DIR/" 2>/dev/null || echo "Directory not accessible"
            fi
            
            # Make binaries executable
            chmod +x /tmp/clang-binaries/bin/clang++ /tmp/clang-binaries/bin/clang 2>/dev/null || true
            
            echo "✓ Clang toolchain prepared in temporary location"
          else
            echo "Warning: Could not find extracted clang directory, using system clang"
            # Fallback to system clang
            SYSTEM_CLANG=$(which clang++)
            if [ -n "$SYSTEM_CLANG" ]; then
              echo "Found system clang at: $SYSTEM_CLANG"
              cp "$SYSTEM_CLANG" AppDir/usr/bin/clang++ || true
              cp "$(which clang)" AppDir/usr/bin/clang || true
              
              # Set CLANG_DIR to system clang directory for header copying later
              CLANG_DIR=$(dirname "$SYSTEM_CLANG")/..
              
              # Try to find and copy system clang libraries
              CLANG_LIB_DIR=$(dirname "$SYSTEM_CLANG")/../lib
              if [ -d "$CLANG_LIB_DIR" ]; then
                echo "Copying system clang libraries from: $CLANG_LIB_DIR"
                find "$CLANG_LIB_DIR" -name "libclang*.so*" -type f -exec cp {} AppDir/usr/lib/clang-libs/ \; 2>/dev/null || true
              fi
              
              echo "System clang libraries in AppDir:"
              ls -lh AppDir/usr/lib/clang-libs/ 2>/dev/null | head -20 || echo "No files found!"
            else
              echo "ERROR: No clang compiler found!"
            fi
          fi
          
          rm -f /tmp/clang.tar.xz
          
          ################### Download and extract musl libc headers for clang ###################
          echo "Downloading musl libc for C standard headers..."
          MUSL_VERSION="1.2.5"
          MUSL_INSTALL_DIR="/tmp/musl-install"
          mkdir -p /tmp/musl-build
          cd /tmp/musl-build
          
          # Download musl libc source
          wget -q https://musl.libc.org/releases/musl-${MUSL_VERSION}.tar.gz -O musl.tar.gz || {
            echo "Failed to download musl, trying alternative..."
            wget -q https://github.com/musl-libc/musl/releases/download/v${MUSL_VERSION}/musl-${MUSL_VERSION}.tar.gz -O musl.tar.gz || {
              echo "Failed to download musl, using system headers as fallback"
              exit 0
            }
          }
          
          tar -xzf musl.tar.gz
          cd musl-${MUSL_VERSION}
          
          # Configure and install musl headers only (no compilation needed)
          echo "Configuring musl..."
          ./configure --prefix=${MUSL_INSTALL_DIR} 2>&1 | tail -5
          echo "Installing musl headers..."
          make install-headers 2>&1 | tail -5
          
          # Verify musl headers were installed
          echo "Verifying musl headers installation..."
          if [ -f "${MUSL_INSTALL_DIR}/include/stddef.h" ]; then
            echo "✓ Found stddef.h in musl install"
            ls -lh ${MUSL_INSTALL_DIR}/include/std*.h | head -5
          else
            echo "✗ stddef.h NOT found in musl install!"
            ls -la ${MUSL_INSTALL_DIR}/include/ 2>/dev/null | head -20
          fi
          
          # Copy musl headers to temporary location (will copy to AppDir later)
          echo "Copying musl C headers to temporary location..."
          mkdir -p /tmp/appimage-headers/include
          if [ -d "${MUSL_INSTALL_DIR}/include" ]; then
            echo "Source directory exists: ${MUSL_INSTALL_DIR}/include"
            ls -la ${MUSL_INSTALL_DIR}/include/ | head -10
            cp -rv ${MUSL_INSTALL_DIR}/include/* /tmp/appimage-headers/include/ 2>&1 | head -20
            echo "Verifying copy..."
            if [ -f "/tmp/appimage-headers/include/stddef.h" ]; then
              echo "✓ stddef.h successfully copied to temporary location"
            else
              echo "✗ stddef.h NOT in temporary location after copy!"
            fi
          else
            echo "✗ Source directory does not exist: ${MUSL_INSTALL_DIR}/include"
          fi
          
          # CRITICAL: Copy musl bits/ subdirectory (contains alltypes.h, types/mbstate_t.h, etc.)
          # This is needed by libc++ to find mbstate_t definition
          echo "Copying musl bits/ subdirectory..."
          if [ -d "${MUSL_INSTALL_DIR}/include/bits" ]; then
            echo "Found bits/ directory at ${MUSL_INSTALL_DIR}/include/bits"
            cp -rv "${MUSL_INSTALL_DIR}/include/bits" /tmp/appimage-headers/include/ 2>&1 | head -20
            if [ -f "/tmp/appimage-headers/include/bits/alltypes.h" ]; then
              echo "✓ alltypes.h successfully copied"
            else
              echo "✗ alltypes.h NOT found after copy!"
            fi
          else
            echo "⚠ bits/ directory not found in musl install"
            ls -la "${MUSL_INSTALL_DIR}/include/" 2>/dev/null | head -20
          fi
          
          # Copy C++ standard library headers from LLVM (NOT system!)
          echo "Copying C++ standard library headers from LLVM to temporary location..."
          
          # LLVM 21 uses libc++ with headers in lib/c++/v1
          if [ -d "$CLANG_DIR/lib/c++/v1" ]; then
            echo "Found libc++ headers at $CLANG_DIR/lib/c++/v1"
            mkdir -p /tmp/appimage-headers/include/c++
            cp -rv "$CLANG_DIR/lib/c++/v1" /tmp/appimage-headers/include/c++/ 2>&1 | head -20
            echo "✓ Copied LLVM libc++ headers from lib/c++/v1"
          elif [ -d "$CLANG_DIR/include/c++" ]; then
            echo "Found C++ headers at $CLANG_DIR/include/c++"
            cp -rv "$CLANG_DIR/include/c++" /tmp/appimage-headers/include/ 2>&1 | head -20
            echo "✓ Copied LLVM C++ headers"
          else
            echo "⚠ LLVM C++ headers not found in expected locations"
            echo "  Falling back to system headers"
            if [ -d "/usr/include/c++" ]; then
              cp -r /usr/include/c++ /tmp/appimage-headers/include/ 2>/dev/null || true
            fi
          fi
          
          # CRITICAL: Copy platform-specific C++ config headers (__config_site)
          # These are in include/x86_64-unknown-linux-gnu/c++/v1 in LLVM 21
          echo "Copying platform-specific C++ config headers..."
          if [ -d "$CLANG_DIR/include/x86_64-unknown-linux-gnu/c++/v1" ]; then
            echo "Found platform-specific C++ headers at $CLANG_DIR/include/x86_64-unknown-linux-gnu/c++/v1"
            mkdir -p /tmp/appimage-headers/include/x86_64-unknown-linux-gnu/c++
            cp -rv "$CLANG_DIR/include/x86_64-unknown-linux-gnu/c++/v1" /tmp/appimage-headers/include/x86_64-unknown-linux-gnu/c++/ 2>&1 | head -20
            echo "✓ Copied platform-specific C++ headers (__config_site, etc.)"
            
            # Verify __config_site was copied
            if [ -f "/tmp/appimage-headers/include/x86_64-unknown-linux-gnu/c++/v1/__config_site" ]; then
              echo "✓ Found __config_site in temporary location"
            else
              echo "✗ __config_site NOT found in temporary location!"
            fi
          else
            echo "⚠ Platform-specific C++ headers not found at $CLANG_DIR/include/x86_64-unknown-linux-gnu/c++/v1"
            echo "  Searching for __config_site in entire CLANG_DIR..."
            CONFIG_SITE_PATH=$(find "$CLANG_DIR" -name "__config_site" 2>/dev/null | head -1)
            if [ -n "$CONFIG_SITE_PATH" ]; then
              echo "  Found __config_site at: $CONFIG_SITE_PATH"
              CONFIG_SITE_DIR=$(dirname "$CONFIG_SITE_PATH")
              echo "  Copying from: $CONFIG_SITE_DIR"
              mkdir -p /tmp/appimage-headers/include/x86_64-unknown-linux-gnu/c++/v1
              cp -v "$CONFIG_SITE_PATH" /tmp/appimage-headers/include/x86_64-unknown-linux-gnu/c++/v1/
              echo "✓ Copied __config_site"
            else
              echo "✗ __config_site not found anywhere in CLANG_DIR!"
            fi
          fi
          
          # CRITICAL: Add _LIBCPP_HAS_MUSL_LIBC flag and C header wrapper defines to __config_site
          # This tells libc++ to use musl's bits/alltypes.h for mbstate_t definition
          # AND tells cstdio, cstdlib, etc. that their .h wrappers are available
          echo "Adding _LIBCPP_HAS_MUSL_LIBC and C header wrapper defines to __config_site..."
          CONFIG_SITE_FILE="/tmp/appimage-headers/include/x86_64-unknown-linux-gnu/c++/v1/__config_site"
          if [ -f "$CONFIG_SITE_FILE" ]; then
            echo "Modifying __config_site to enable musl libc support and C header wrappers..."
            # Add the flags at the beginning of the file (after any header comments)
            {
              echo ""
              echo "// Enable musl libc support for mbstate_t definition"
              echo "#define _LIBCPP_HAS_MUSL_LIBC 1"
              echo ""
              echo "// Define C header wrapper macros so cstdio, cstdlib, etc. find their .h wrappers"
              echo "#define _LIBCPP_STDIO_H"
              echo "#define _LIBCPP_STDLIB_H"
              echo "#define _LIBCPP_WCHAR_H"
              echo "#define _LIBCPP_WCTYPE_H"
              echo "#define _LIBCPP_CTYPE_H"
              echo "#define _LIBCPP_MATH_H"
              echo "#define _LIBCPP_ERRNO_H"
              echo "#define _LIBCPP_STRING_H"
              echo "#define _LIBCPP_STDDEF_H"
              echo ""
              echo "// Undefine problematic macros from musl math.h that conflict with C++ code"
              echo "// These macros are defined in musl's math.h but break libc++ C++ code"
              echo "#undef isinf"
              echo "#undef isnan"
              echo "#undef signbit"
              echo "#undef isfinite"
              echo "#undef isnormal"
              echo "#undef isgreater"
              echo "#undef isgreaterequal"
              echo "#undef isless"
              echo "#undef islessequal"
              echo "#undef islessgreater"
              echo "#undef isunordered"
              cat "$CONFIG_SITE_FILE"
            } > "$CONFIG_SITE_FILE.tmp"
            mv "$CONFIG_SITE_FILE.tmp" "$CONFIG_SITE_FILE"
            echo "✓ Added _LIBCPP_HAS_MUSL_LIBC and C header wrapper defines to __config_site"
            
            # Verify the flags were added
            if grep -q "_LIBCPP_HAS_MUSL_LIBC" "$CONFIG_SITE_FILE" && grep -q "_LIBCPP_STDIO_H" "$CONFIG_SITE_FILE"; then
              echo "✓ Verified all defines are in __config_site"
              echo "First 15 lines of modified __config_site:"
              head -15 "$CONFIG_SITE_FILE"
            else
              echo "✗ Failed to add defines to __config_site!"
            fi
          else
            echo "✗ __config_site not found at: $CONFIG_SITE_FILE"
            echo "Cannot add defines!"
          fi
          
          # CRITICAL: Copy libc++ C headers wrappers (stdio.h, stdlib.h, wchar.h, etc.)
          # These are in include/c++/v1 alongside the C++ headers
          # IMPORTANT: Must copy BOTH c* files (cstdio, cstdlib, etc.) AND their corresponding .h files (stdio.h, stdlib.h, etc.)
          echo "Copying libc++ C headers wrappers..."
          if [ -d "$CLANG_DIR/include/c++/v1" ]; then
            echo "Copying C header wrappers from $CLANG_DIR/include/c++/v1..."
            
            # Copy C++ wrapper files (c*)
            cp -v "$CLANG_DIR/include/c++/v1/cstdio" /tmp/appimage-headers/include/c++/v1/ 2>/dev/null || true
            cp -v "$CLANG_DIR/include/c++/v1/cstdlib" /tmp/appimage-headers/include/c++/v1/ 2>/dev/null || true
            cp -v "$CLANG_DIR/include/c++/v1/cwchar" /tmp/appimage-headers/include/c++/v1/ 2>/dev/null || true
            cp -v "$CLANG_DIR/include/c++/v1/cwctype" /tmp/appimage-headers/include/c++/v1/ 2>/dev/null || true
            cp -v "$CLANG_DIR/include/c++/v1/cctype" /tmp/appimage-headers/include/c++/v1/ 2>/dev/null || true
            cp -v "$CLANG_DIR/include/c++/v1/cstddef" /tmp/appimage-headers/include/c++/v1/ 2>/dev/null || true
            cp -v "$CLANG_DIR/include/c++/v1/cmath" /tmp/appimage-headers/include/c++/v1/ 2>/dev/null || true
            cp -v "$CLANG_DIR/include/c++/v1/cerrno" /tmp/appimage-headers/include/c++/v1/ 2>/dev/null || true
            cp -v "$CLANG_DIR/include/c++/v1/cstring" /tmp/appimage-headers/include/c++/v1/ 2>/dev/null || true
            
            # Copy C header wrapper files (.h versions) - CRITICAL!
            # These define _LIBCPP_STDIO_H, _LIBCPP_STDLIB_H, etc. that cstdio, cstdlib, etc. look for
            cp -v "$CLANG_DIR/include/c++/v1/stdio.h" /tmp/appimage-headers/include/c++/v1/ 2>/dev/null || true
            cp -v "$CLANG_DIR/include/c++/v1/stdlib.h" /tmp/appimage-headers/include/c++/v1/ 2>/dev/null || true
            cp -v "$CLANG_DIR/include/c++/v1/wchar.h" /tmp/appimage-headers/include/c++/v1/ 2>/dev/null || true
            cp -v "$CLANG_DIR/include/c++/v1/wctype.h" /tmp/appimage-headers/include/c++/v1/ 2>/dev/null || true
            cp -v "$CLANG_DIR/include/c++/v1/ctype.h" /tmp/appimage-headers/include/c++/v1/ 2>/dev/null || true
            cp -v "$CLANG_DIR/include/c++/v1/math.h" /tmp/appimage-headers/include/c++/v1/ 2>/dev/null || true
            cp -v "$CLANG_DIR/include/c++/v1/errno.h" /tmp/appimage-headers/include/c++/v1/ 2>/dev/null || true
            cp -v "$CLANG_DIR/include/c++/v1/string.h" /tmp/appimage-headers/include/c++/v1/ 2>/dev/null || true
            
            # Verify key headers were copied
            if [ -f "/tmp/appimage-headers/include/c++/v1/stdio.h" ]; then
              echo "✓ Copied libc++ C header wrappers (including stdio.h)"
            else
              echo "⚠ stdio.h wrapper not found in CLANG_DIR/include/c++/v1"
              echo "  Available .h files in $CLANG_DIR/include/c++/v1:"
              ls -1 "$CLANG_DIR/include/c++/v1"/*.h 2>/dev/null | head -20 || echo "  No .h files found"
            fi
          fi
          
          # Copy GCC include directory from LLVM (for intrinsics, etc.)
          echo "Copying GCC include directory from LLVM to temporary location..."
          if [ -d "$CLANG_DIR/lib/clang/21/include" ]; then
            mkdir -p /tmp/appimage-headers/lib/clang/21
            cp -rv "$CLANG_DIR/lib/clang/21/include" /tmp/appimage-headers/lib/clang/21/ 2>&1 | head -20
            echo "✓ Copied LLVM clang intrinsics headers"
            # Verify key headers
            if [ -f "/tmp/appimage-headers/lib/clang/21/include/stddef.h" ]; then
              echo "✓ Found stddef.h in LLVM clang headers"
            fi
          else
            echo "⚠ LLVM clang/21/include not found at: $CLANG_DIR/lib/clang/21/include"
            # Try to find clang version
            if [ -d "$CLANG_DIR/lib/clang" ]; then
              echo "Available clang versions:"
              ls -la "$CLANG_DIR/lib/clang/"
            fi
          fi
          
          # Also copy system GCC headers as fallback
          echo "Copying system GCC include directory as fallback to temporary location..."
          GCC_VERSION=$(ls /usr/lib/gcc/x86_64-linux-gnu/ 2>/dev/null | head -1)
          if [ -n "$GCC_VERSION" ]; then
            mkdir -p "/tmp/appimage-headers/lib/gcc/x86_64-linux-gnu/$GCC_VERSION"
            cp -r "/usr/lib/gcc/x86_64-linux-gnu/$GCC_VERSION/include" "/tmp/appimage-headers/lib/gcc/x86_64-linux-gnu/$GCC_VERSION/" 2>/dev/null || true
            cp -r "/usr/lib/gcc/x86_64-linux-gnu/$GCC_VERSION/include-fixed" "/tmp/appimage-headers/lib/gcc/x86_64-linux-gnu/$GCC_VERSION/" 2>/dev/null || true
          fi
          
          # Final verification of all headers in temporary location
          echo ""
          echo "=== FINAL VERIFICATION: Headers in temporary location ==="
          echo "Checking for stddef.h in multiple locations:"
          find /tmp/appimage-headers/include -name "stddef.h" 2>/dev/null | head -10 || echo "✗ stddef.h NOT found in temporary location"
          find /tmp/appimage-headers/lib/clang -name "stddef.h" 2>/dev/null | head -10 || echo "✗ stddef.h NOT found in clang headers"
          
          echo ""
          echo "Checking for wchar.h:"
          find /tmp/appimage-headers/include -name "wchar.h" 2>/dev/null | head -5 || echo "✗ wchar.h NOT found"
          
          echo ""
          echo "Checking C++ headers:"
          ls -la /tmp/appimage-headers/include/c++/ 2>/dev/null | head -10 || echo "✗ C++ headers NOT found"
          
          echo ""
          echo "Musl headers and C++ headers copied to temporary location successfully"

      ################### build application ###################
      - name: Configure CMake
        run: |
          mkdir -p build
          cd build
          
          # Set CLANG_TOOLCHAIN_PATH for plugin compilation (runtime)
          # but use system compiler for building the application
          CLANG_TOOLCHAIN_PATH="${GITHUB_WORKSPACE}/AppDir/usr/bin"
          
          cmake .. \
            -DCMAKE_BUILD_TYPE=Release \
            -DOOPENCAL_DIR=${{ github.workspace }}/deps \
            -DCMAKE_INSTALL_PREFIX=/usr \
            -DCLANG_TOOLCHAIN_PATH="$CLANG_TOOLCHAIN_PATH"

      - name: Build application
        run: |
          cd build
          cmake --build . --parallel $(nproc)

      - name: Install to temporary directory
        run: |
          cd build
          DESTDIR=${{ github.workspace }}/AppDir cmake --install .

      ################### prepare AppDir structure ###################
      - name: Create AppDir structure
        run: |
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/lib
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
          mkdir -p AppDir/usr/include

          # Copy main executable
          cp build/${PROJECT_NAME} AppDir/usr/bin/ || \
          cp AppDir/usr/bin/${PROJECT_NAME} AppDir/usr/bin/ || true

      - name: Copy VTK headers to temporary location
        run: |
          echo "Copying VTK headers to temporary location..."
          
          # Find VTK headers
          VTK_INCLUDE_DIR=$(find /usr/include -maxdepth 1 -name "vtk*" -type d 2>/dev/null | head -1)
          if [ -n "$VTK_INCLUDE_DIR" ]; then
            echo "Found VTK headers at: $VTK_INCLUDE_DIR"
            mkdir -p /tmp/appimage-headers/include
            cp -rv "$VTK_INCLUDE_DIR" /tmp/appimage-headers/include/ 2>&1 | head -20
            echo "✓ VTK headers copied to temporary location"
            
            # Verify key VTK headers
            VTK_DIR_NAME=$(basename "$VTK_INCLUDE_DIR")
            if [ -f "/tmp/appimage-headers/include/$VTK_DIR_NAME/vtkRenderer.h" ]; then
              echo "✓ vtkRenderer.h found in temporary location"
            fi
          else
            echo "⚠ VTK headers not found in /usr/include"
            echo "Available include directories:"
            ls -d /usr/include/vtk* 2>/dev/null || echo "No vtk* directories found"
          fi

      - name: Copy bundled headers from temporary location
        run: |
          echo "Copying bundled headers from temporary location to AppDir..."
          
          # Copy musl and system headers
          if [ -d "/tmp/appimage-headers/include" ]; then
            echo "Copying include headers..."
            cp -rv /tmp/appimage-headers/include/* AppDir/usr/include/ 2>&1 | head -20
            if [ -f "AppDir/usr/include/stddef.h" ]; then
              echo "✓ stddef.h successfully copied to AppDir"
            else
              echo "✗ stddef.h NOT in AppDir after copy!"
            fi
            
            # CRITICAL: Verify bits/alltypes.h was copied
            if [ -f "AppDir/usr/include/bits/alltypes.h" ]; then
              echo "✓ bits/alltypes.h successfully copied to AppDir"
            else
              echo "✗ bits/alltypes.h NOT in AppDir after copy!"
              echo "Checking if bits/ directory exists in /tmp/appimage-headers/include:"
              ls -la /tmp/appimage-headers/include/bits/ 2>/dev/null | head -10 || echo "bits/ directory not found in /tmp/appimage-headers/include"
              echo "Checking if bits/ directory exists in AppDir/usr/include:"
              ls -la AppDir/usr/include/bits/ 2>/dev/null | head -10 || echo "bits/ directory not found in AppDir/usr/include"
            fi
          fi
          
          # Copy clang intrinsics headers
          if [ -d "/tmp/appimage-headers/lib/clang" ]; then
            echo "Copying clang intrinsics headers..."
            mkdir -p AppDir/usr/lib/clang
            cp -rv /tmp/appimage-headers/lib/clang/* AppDir/usr/lib/clang/ 2>&1 | head -20
            if [ -f "AppDir/usr/lib/clang/21/include/stddef.h" ]; then
              echo "✓ stddef.h in clang headers successfully copied"
            fi
          fi
          
          # Copy GCC headers
          if [ -d "/tmp/appimage-headers/lib/gcc" ]; then
            echo "Copying GCC headers..."
            mkdir -p AppDir/usr/lib/gcc
            cp -rv /tmp/appimage-headers/lib/gcc/* AppDir/usr/lib/gcc/ 2>&1 | head -20
          fi
          
          echo "Bundled headers copied successfully"

      - name: Copy clang binaries and libraries from temporary location
        run: |
          echo "Copying clang binaries and libraries from temporary location..."
          
          # Copy clang binaries
          if [ -d "/tmp/clang-binaries/bin" ]; then
            echo "Copying clang binaries..."
            mkdir -p AppDir/usr/bin
            cp -v /tmp/clang-binaries/bin/clang++ AppDir/usr/bin/ || true
            cp -v /tmp/clang-binaries/bin/clang AppDir/usr/bin/ || true
            cp -v /tmp/clang-binaries/bin/clang-cpp AppDir/usr/bin/ || true
            chmod +x AppDir/usr/bin/clang++ AppDir/usr/bin/clang 2>/dev/null || true
            echo "✓ Clang binaries copied"
          fi
          
          # Copy clang libraries
          if [ -d "/tmp/clang-binaries/lib" ]; then
            echo "Copying clang libraries..."
            mkdir -p AppDir/usr/lib/clang-libs
            cp -rv /tmp/clang-binaries/lib/* AppDir/usr/lib/clang-libs/ 2>&1 | head -20
            echo "✓ Clang libraries copied"
          fi
          
          # Verify clang is in AppDir
          if [ -f "AppDir/usr/bin/clang++" ]; then
            echo "✓ clang++ found in AppDir"
            ls -lh AppDir/usr/bin/clang++
          else
            echo "✗ clang++ NOT found in AppDir!"
          fi

      - name: Copy precompiled header and project headers
        run: |
          # Create all necessary include directories
          mkdir -p AppDir/usr/include/utilities
          mkdir -p AppDir/usr/include/visualiser
          mkdir -p AppDir/usr/include/visualiserProxy
          mkdir -p AppDir/usr/include/config
          mkdir -p AppDir/usr/include/widgets

          # Copy precompiled header if it exists
          if [ -f "build/include/SceneWidgetVisualizer.pch.gch" ]; then
            cp build/include/SceneWidgetVisualizer.pch.gch AppDir/usr/include/ || true
            echo "Precompiled header copied successfully"
          else
            echo "Warning: Precompiled header not found at build/include/SceneWidgetVisualizer.pch.gch"
          fi

          # Copy precompiled header source
          if [ -f "visualiserProxy/SceneWidgetVisualizer.pch.h" ]; then
            cp visualiserProxy/SceneWidgetVisualizer.pch.h AppDir/usr/include/ || true
          fi

          # Copy all headers from utilities/
          if [ -d "utilities" ]; then
            cp -r utilities/*.h AppDir/usr/include/utilities/ 2>/dev/null || true
            cp -r utilities/*.hpp AppDir/usr/include/utilities/ 2>/dev/null || true
          fi

          # Copy all headers from visualiser/
          if [ -d "visualiser" ]; then
            cp -r visualiser/*.h AppDir/usr/include/visualiser/ 2>/dev/null || true
            cp -r visualiser/*.hpp AppDir/usr/include/visualiser/ 2>/dev/null || true
          fi

          # Copy all headers from visualiserProxy/
          if [ -d "visualiserProxy" ]; then
            cp -r visualiserProxy/*.h AppDir/usr/include/visualiserProxy/ 2>/dev/null || true
            cp -r visualiserProxy/*.hpp AppDir/usr/include/visualiserProxy/ 2>/dev/null || true
          fi

          # Copy all headers from config/
          if [ -d "config" ]; then
            cp -r config/*.h AppDir/usr/include/config/ 2>/dev/null || true
            cp -r config/*.hpp AppDir/usr/include/config/ 2>/dev/null || true
          fi

          # Copy all headers from widgets/
          if [ -d "widgets" ]; then
            cp -r widgets/*.h AppDir/usr/include/widgets/ 2>/dev/null || true
            cp -r widgets/*.hpp AppDir/usr/include/widgets/ 2>/dev/null || true
          fi

          echo "Project headers copied successfully"

      - name: Copy VTK headers
        run: |
          # Copy VTK headers
          if [ -d "/usr/include/vtk-9.1" ]; then
            mkdir -p AppDir/usr/include/vtk
            cp -r /usr/include/vtk-9.1/* AppDir/usr/include/vtk/ || true
          elif [ -d "/usr/include/vtk" ]; then
            cp -r /usr/include/vtk AppDir/usr/include/ || true
          fi

      - name: Copy Qt libraries
        run: |
          # Find Qt library path
          QT_LIB_PATH=$(qmake -query QT_INSTALL_LIBS)

          # Copy essential Qt libraries
          for lib in Core Gui Widgets OpenGL DBus XcbQpa; do
            cp -P ${QT_LIB_PATH}/libQt5${lib}.so* AppDir/usr/lib/ || true
          done

          # Copy Qt plugins
          QT_PLUGINS=$(qmake -query QT_INSTALL_PLUGINS)
          mkdir -p AppDir/usr/plugins
          cp -r ${QT_PLUGINS}/platforms AppDir/usr/plugins/ || true
          cp -r ${QT_PLUGINS}/xcbglintegrations AppDir/usr/plugins/ || true
          cp -r ${QT_PLUGINS}/imageformats AppDir/usr/plugins/ || true

      - name: Copy VTK libraries
        run: |
          # Find and copy VTK libraries
          VTK_LIBS=$(find /usr/lib/x86_64-linux-gnu -name "libvtk*.so*" -type f)
          for lib in $VTK_LIBS; do
            cp -P $lib AppDir/usr/lib/ || true
            # Also copy symlinks
            if [ -L $lib ]; then
              cp -d $lib AppDir/usr/lib/ || true
            fi
          done

          # Copy VTK dependencies
          for lib in /usr/lib/x86_64-linux-gnu/libvtk*.so*; do
            [ -e "$lib" ] && cp -P "$lib" AppDir/usr/lib/ || true
          done

      - name: Copy system dependencies
        run: |
          # Function to copy library and its dependencies
          copy_deps() {
            local binary=$1
            ldd "$binary" 2>/dev/null | grep "=> /" | awk '{print $3}' | while read lib; do
              if [ -f "$lib" ]; then
                # Skip system libraries that should be on every system
                case "$lib" in
                  /lib/x86_64-linux-gnu/libc.so*|\
                  /lib/x86_64-linux-gnu/libm.so*|\
                  /lib/x86_64-linux-gnu/libdl.so*|\
                  /lib/x86_64-linux-gnu/libpthread.so*|\
                  /lib/x86_64-linux-gnu/librt.so*|\
                  /lib/x86_64-linux-gnu/ld-linux*.so*)
                    continue
                    ;;
                esac
                cp -n "$lib" AppDir/usr/lib/ 2>/dev/null || true
              fi
            done
          }

          # Copy dependencies for main executable
          copy_deps "AppDir/usr/bin/${PROJECT_NAME}"

          # Copy dependencies for Qt and VTK libraries
          for lib in AppDir/usr/lib/*.so*; do
            [ -f "$lib" ] && copy_deps "$lib"
          done

      ################### icons and desktop entry ###################
      - name: Prepare application icon
        run: |
          if [ -f icons/application.png ]; then
            cp icons/application.png AppDir/usr/share/icons/hicolor/256x256/apps/${PROJECT_NAME}.png
            cp icons/application.png AppDir/${PROJECT_NAME}.png
          else
            # Create a dummy icon if none exists
            convert -size 256x256 xc:blue AppDir/${PROJECT_NAME}.png
            cp AppDir/${PROJECT_NAME}.png AppDir/usr/share/icons/hicolor/256x256/apps/${PROJECT_NAME}.png
          fi

      - name: Create .desktop file
        run: |
          cat > AppDir/${PROJECT_NAME}.desktop << EOF
          [Desktop Entry]
          Name=${PROJECT_NAME}
          Exec=${PROJECT_NAME}
          Icon=${PROJECT_NAME}
          Type=Application
          Categories=Utility;Science;
          EOF

          cp AppDir/${PROJECT_NAME}.desktop AppDir/usr/share/applications/

      - name: Create AppRun script
        run: |
          cat > AppDir/AppRun << EOF
          #!/bin/bash
          SELF=\$(readlink -f "\$0")
          HERE=\${SELF%/*}

          # Set up library path for Qt and other libraries
          # (clang++ will use RPATH to find its own libraries)
          export LD_LIBRARY_PATH="\${HERE}/usr/lib:\${LD_LIBRARY_PATH}"

          # Set up Qt plugin path
          export QT_PLUGIN_PATH="\${HERE}/usr/plugins"
          export QT_QPA_PLATFORM_PLUGIN_PATH="\${HERE}/usr/plugins/platforms"

          # Set OOPENCAL_VIEWER_ROOT to point to AppImage include directory
          export OOPENCAL_VIEWER_ROOT="\${HERE}/usr/include"

          # Set PRECOMPILED_HEADER_PATH for plugin compilation
          export PRECOMPILED_HEADER_PATH="\${HERE}/usr/include"

          # Set clang toolchain path for plugin compilation
          export CLANG_TOOLCHAIN_PATH="\${HERE}/usr/bin"

          # Disable Qt's automatic high DPI scaling (user can set QT_AUTO_SCREEN_SCALE_FACTOR=1 if needed)
          export QT_AUTO_SCREEN_SCALE_FACTOR=0

          # Execute the application
          exec "\${HERE}/usr/bin/${PROJECT_NAME}" "\$@"
          EOF

          chmod +x AppDir/AppRun

      - name: Fix RPATH for all binaries and libraries
        run: |
          # Fix RPATH for main executable
          patchelf --set-rpath '$ORIGIN/../lib' AppDir/usr/bin/${PROJECT_NAME} || true

          # Fix RPATH for clang++ to find its libraries
          if [ -f "AppDir/usr/bin/clang++" ]; then
            patchelf --set-rpath '$ORIGIN/../lib/clang-libs:$ORIGIN/../lib' AppDir/usr/bin/clang++ || true
          fi

          # Fix RPATH for all libraries
          find AppDir/usr/lib -name "*.so*" -type f -exec \
            patchelf --set-rpath '$ORIGIN' {} \; 2>/dev/null || true

      ################### create AppImage ###################
      - name: Download appimagetool
        run: |
          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage

      - name: Create AppImage
        run: |
          # Use --appimage-extract-and-run to work without FUSE in CI environment
          # Set ARCH explicitly to avoid architecture detection issues
          ARCH=x86_64 ./appimagetool-x86_64.AppImage --appimage-extract-and-run AppDir ${PROJECT_NAME}-x86_64.AppImage
          chmod +x ${PROJECT_NAME}-x86_64.AppImage

      ################### artifacts ###################
      - name: Upload AppImage artifact
        if: ${{ !env.ACT }}
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PROJECT_NAME }}-AppImage
          path: ${{ env.PROJECT_NAME }}-x86_64.AppImage

      - name: Export AppImage outside container (act only)
        if: ${{ env.ACT }}
        run: |
          mkdir -p /github/workspace/out
          cp ${PROJECT_NAME}-x86_64.AppImage /github/workspace/out/

      ################### release upload ###################
      - name: Upload AppImage to GitHub Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.PROJECT_NAME }}-x86_64.AppImage
